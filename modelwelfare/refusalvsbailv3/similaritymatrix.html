<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Model similarity matrix</title>
<script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<style>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
body{font-family:Arial,Helvetica,sans-serif;background:#f5f7fa;margin:0;padding:20px;}
.wrapper{margin:0;max-width:none;background:#fff;box-shadow:0 0 10px rgba(0,0,0,.08);
         display:flex;flex-direction:column;align-items:center;}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ heading & dropdowns â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
h1{margin:.8rem 0 1.1rem;text-align:center;color:#2c3e50;}
.ctrl-row{display:flex;flex-wrap:wrap;justify-content:center;align-items:center;
          gap:.6rem;margin-bottom:1rem;}
select{padding:.45rem .8rem;font-size:1rem;border:1px solid #ccc;border-radius:6px;}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ similarity matrix â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
table.simMat{border-collapse:collapse;border-spacing:0;margin-bottom:1.2rem;}
table.simMat td.cell,table.simMat th.vert,table.simMat tbody th{
  border:1px solid #fff;font-size:.75rem;}
table.simMat td.cell{width:26px;height:26px;cursor:pointer;}
table.simMat th.vert{writing-mode:vertical-rl;transform:rotate(180deg);
  padding:.5rem .25rem;color:#34495e;background:#f7fbff;}
table.simMat tbody th{padding:.25rem .5rem;color:#34495e;background:#f7fbff;text-align:right;}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ model selector card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card{border:1px solid #d0d7e2;border-radius:8px;padding:1rem 1.2rem;
      margin-bottom:1.6rem;box-shadow:0 1px 3px rgba(0,0,0,.04);}
.card h3{margin:0 0 .6rem;font-size:1rem;color:#2c3e50;text-align:center;}
.button-row{display:flex;justify-content:center;gap:.8rem;margin-bottom:.8rem;}
button.btn{padding:.35rem .9rem;font-size:.85rem;border:1px solid #3498db;
           color:#fff;background:#3498db;border-radius:6px;cursor:pointer;}
button.btn:hover{background:#2980b9;border-color:#2980b9;}
button.btn.secondary{background:#95a5a6;border-color:#95a5a6;}
button.btn.secondary:hover{background:#7f8c8d;border-color:#7f8c8d;}
.model-list{display:flex;flex-direction:column;gap:.35rem;max-height:320px;
            overflow:auto;font-size:.85rem;}
.model-list label{display:flex;align-items:center;gap:.45rem;cursor:pointer;}
.model-list input[type="checkbox"]{accent-color:#2c7bb6;}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ description â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.desc{max-width:800px;font-size:.9rem;line-height:1.45;
      padding:0 1rem 2rem;color:#34495e;}
.desc code{background:#f0f0f0;padding:2px 4px;border-radius:4px;}

a{color:#3498db;text-decoration:none;font-weight:bold;margin-right:.6rem;}
a:hover{text-decoration:underline;}
</style>
</head>
<body>

<a href="/modelwelfare/refusalvsbailv3/summary.html">View data summary</a>

<div class="wrapper">

  <h1>Model similarity matrix</h1>

  <div class="ctrl-row">
    <label><strong>Metric:</strong></label>
    <select id="metricSelect">
      <option value="bail.l">Leave / bail rate (ðŸŸ¢ vs ðŸ”„)</option>
      <option value="ref.r">Refusal rate</option>
    </select>

    <label><strong>Normalisation:</strong></label>
    <select id="normSelect">
      <option value="logit">Log-odds residual</option>
      <option value="center">Centered rate</option>
      <option value="relative">Relative rate</option>
    </select>
  </div>

  <div style="overflow:auto;">
    <table id="simTable" class="simMat"></table>
  </div>

  <!-- â”€â”€ model selector card â”€â”€ -->
  <div class="card" style="width:min(320px,90%);">
    <h3>Models displayed</h3>
    <div class="button-row">
      <button id="btnAll"   class="btn">Select all</button>
      <button id="btnClear" class="btn secondary">Clear all</button>
    </div>
    <div id="modelList" class="model-list"></div>
  </div>

  <!-- descriptive text (unchanged) -->

<div class="desc">
    <h2 style="margin:.2rem 0 .6rem;">What youâ€™re seeing</h2>
    <p>
      Each cell shows the cosine similarity between two models after we:
      <ol style="margin-left:1.4rem">
        <li>extract either the <em>leave / bail rate</em>
            \(b_{mc}\) or the <em>refusal rate</em> \(r_{mc}\)
            for every fine-grained category \(c\);</li>
        <li>apply the chosen normalisation to obtain
            \(\tilde b_{mc}\) or \(\tilde r_{mc}\);</li>
        <li>compute
            \(\displaystyle
              \mathrm{sim}(a,b)=
              \frac{\tilde{\mathbf v}_a\!\cdot\!\tilde{\mathbf v}_b}
                   {\lVert\tilde{\mathbf v}_a\rVert\;
                    \lVert\tilde{\mathbf v}_b\rVert},
            \)
            which equals Pearson correlation when vectors are centred.</li>
      </ol>
    </p>

    <p>
      Colours follow Plotlyâ€™s diverging <code>RdBu</code> scheme:
      red â‰ˆ anti-correlated, white â‰ˆ uncorrelated, blue â‰ˆ strongly correlated.
    </p>

    <h3 style="margin:.8rem 0 .4rem;">Normalisation formulas</h3>
    <p>
      Let \(\mathbf v_m\) be the raw vector and
      \(\bar v_m=\frac{1}{C}\sum_c v_{mc}\).
    </p>
    <ul>
      <li><strong>Centered rate:</strong>
        \( \tilde v_{mc}=v_{mc}-\bar v_m\)</li>
      <li><strong>Relative rate:</strong>
        \( \tilde v_{mc}=v_{mc}/\bar v_m\)</li>
      <li><strong>Log-odds residual:</strong>
        \( \tilde v_{mc}=\operatorname{logit}(v_{mc})-
           \operatorname{logit}(\bar v_m)\)
        with \(\operatorname{logit}(p)=\ln\!\bigl(p/(1-p)\bigr)\).</li>
    </ul>
  </div>
</div>

<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ configuration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const DATA_URL="/modelwelfare/mergedbailnoswap/summary.json";

let DATA,allModels=[];
let selectedModels=new Set();
let currentMetric="bail.l",currentNorm="logit";

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ hash helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function parseHash(){
  const h=location.hash.slice(1);if(!h)return;
  const p=new URLSearchParams(h);
  if(p.has("metric"))currentMetric=p.get("metric");
  if(p.has("norm"))  currentNorm=p.get("norm");
  if(p.has("models"))selectedModels=new Set(p.get("models").split(","));
}
function updateHash(){
  const p=new URLSearchParams();
  if(currentMetric!=="bail.l")p.set("metric",currentMetric);
  if(currentNorm!=="logit")   p.set("norm",currentNorm);
  if(selectedModels.size && selectedModels.size!==allModels.length)
    p.set("models",[...selectedModels].join(","));
  location.hash=p.toString();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ maths â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const logit=p=>Math.log(p/(1-p));
function normaliseVector(v,mode){
  const n=v.length,avg=v.reduce((a,b)=>a+b,0)/n;
  if(mode==="center")   return v.map(x=>x-avg);
  if(mode==="relative") return v.map(x=>avg?x/avg:0);
  if(mode==="logit"){
    const eps=1e-6,l=v.map(p=>logit(Math.min(Math.max(p/100,eps),1-eps)));
    const m=l.reduce((a,b)=>a+b,0)/n;return l.map(x=>x-m);
  }
  return v;
}
function cosine(a,b){
  let d=0,na=0,nb=0;
  for(let i=0;i<a.length;i++){d+=a[i]*b[i];na+=a[i]*a[i];nb+=b[i]*b[i];}
  return na&&nb?d/Math.sqrt(na*nb):0;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ colour scale â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function simColor(v){
  v=Math.max(-1,Math.min(1,v));
  const s=[[-1,"#d7191c"],[-.5,"#fdae61"],[0,"#ffffff"],[.5,"#abd9e9"],[1,"#2c7bb6"]];
  for(let i=0;i<s.length-1;i++){
    const[p0,c0]=s[i],[p1,c1]=s[i+1];
    if(v>=p0&&v<=p1){
      const t=(v-p0)/(p1-p0),h=hx=>[1,3,5].map(o=>parseInt(hx.substr(o,2),16)),
            r0=h(c0),r1=h(c1),rgb=r0.map((x,j)=>Math.round(x+(r1[j]-x)*t));
      return`rgb(${rgb.join(",")})`;
    }
  }
  return v<0?"#d7191c":"#2c7bb6";
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ data helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function getAgg(m,maj,sub){return DATA.models[m]?.bailFirst?.sub[maj]?.[sub]??null;}
function pickMetric(o){
  if(currentMetric==="bail.l")return o?.bail.l??null;
  if(currentMetric==="ref.r") return o?.ref.r ??null;
  return null;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ build & render matrix â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function buildMatrix(){
  const cats=[];DATA.majorCats.forEach(M=>DATA.subMap[M].forEach(S=>cats.push([M,S])));
  const models=allModels.filter(m=>selectedModels.has(m));
  const vecs=models.map(m=>{
    const v=cats.map(([M,S])=>{
      const a=getAgg(m,M,S),x=pickMetric(a);return x!=null?x*100:0;
    });
    return normaliseVector(v,currentNorm);
  });
  const sim=models.map((_,i)=>models.map((_,j)=>cosine(vecs[i],vecs[j])));
  return{models,sim};
}

function renderSimTable(){
  const{models,sim}=buildMatrix();
  const tbl=document.getElementById("simTable");tbl.innerHTML="";
  const thd=tbl.createTHead().insertRow();thd.insertCell();
  models.forEach(m=>{
    const th=document.createElement("th");th.className="vert";th.textContent=m;
    thd.appendChild(th);
  });
  const tb=document.createElement("tbody");
  sim.forEach((row,i)=>{
    const tr=tb.insertRow();
    const rth=document.createElement("th");rth.textContent=models[i];tr.appendChild(rth);
    row.forEach((v,j)=>{
      const td=tr.insertCell();td.className="cell";
      td.style.backgroundColor=simColor(v);
      td.title=`${v.toFixed(3)}: ${models[i]} â†” ${models[j]}`;
    });
  });
  tbl.appendChild(tb);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ checkbox list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderModelList(){
  const box=document.getElementById("modelList");box.innerHTML="";
  allModels.forEach(m=>{
    const lab=document.createElement("label");
    const cb=document.createElement("input");
    cb.type="checkbox";cb.checked=selectedModels.has(m);
    cb.onchange=()=>{
      cb.checked?selectedModels.add(m):selectedModels.delete(m);
      if(!selectedModels.size)selectedModels=new Set(allModels); // never empty
      renderSimTable();updateHash();
    };
    lab.appendChild(cb);lab.appendChild(document.createTextNode(m));
    box.appendChild(lab);
  });
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function init(){
  parseHash();
  DATA=await fetch(DATA_URL,{cache:"reload"}).then(r=>r.json());
  allModels=Object.keys(DATA.models).sort();
  if(!selectedModels.size)selectedModels=new Set(allModels);

  document.getElementById("metricSelect").value=currentMetric;
  document.getElementById("normSelect").value=currentNorm;

  /* buttons */
  document.getElementById("btnAll").onclick=()=>{
    selectedModels=new Set(allModels);renderModelList();renderSimTable();updateHash();};
  document.getElementById("btnClear").onclick=()=>{
    selectedModels=new Set([allModels[0]]); // keep first to avoid empty matrix
    renderModelList();renderSimTable();updateHash();};

  renderModelList();renderSimTable();

  document.getElementById("metricSelect").onchange=e=>{
    currentMetric=e.target.value;renderSimTable();updateHash();};
  document.getElementById("normSelect").onchange=e=>{
    currentNorm=e.target.value;renderSimTable();updateHash();};
}
window.addEventListener("hashchange",()=>{parseHash();renderModelList();renderSimTable();});
init();
</script>
</body>
</html>