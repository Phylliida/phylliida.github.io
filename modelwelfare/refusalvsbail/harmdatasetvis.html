<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harm Dataset Refusal and Bail Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            position: relative;
        }
        .model-selector {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
        }
        .model-select {
            padding: 8px 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
            background-color: #f8f9fa;
            font-size: 14px;
            cursor: pointer;
            min-width: 150px;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            padding-right: 150px; /* Make space for model selector */
        }
        .charts {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            margin-bottom: 30px;
        }
        .chart-container {
            width: 45%;
            min-width: 250px;
            margin: 10px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .stats {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .stat-card {
            flex: 1;
            min-width: 200px;
            margin: 10px;
            padding: 15px;
            background-color: #f8fafc;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }
        .prompt-box {
            background-color: #eef2f7;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }
        .response-card {
            background-color: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-left: 4px solid #2ecc71;
        }
        .response-text {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .response-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 14px;
            color: white;
        }
        .refused {
            background-color: #e74c3c;
        }
        .unclear {
            background-color: #f39c12;
        }
        .completed {
            background-color: #2ecc71;
        }
        .more-info, .more-information {
            background-color: #9b59b6;
        }
        .wellbeing {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        .wellbeing-icon {
            font-size: 20px;
            margin-right: 10px;
        }
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .category-nav {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .category-btn {
            padding: 10px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .category-btn.active {
            background-color: #2c3e50;
        }
        .subcategory-btn {
            padding: 8px 12px;
            background-color: #5dade2;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-right: 5px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .subcategory-btn.active {
            background-color: #1a5276;
        }
        .subcategory-btn .percentage {
            margin-left: 8px;
            background-color: rgba(255, 255, 255, 0.25);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 12px;
            min-width: 40px;
            text-align: center;
        }
        .prompt-nav {
            display: flex;
            justify-content: space-between;
            width: 100%;
        }
        .prompt-selector {
            flex-grow: 1;
            margin: 0 15px;
        }
        #promptSelect {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 16px;
        }
        .nav-button {
            padding: 8px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .nav-button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        .category-summary {
            background-color: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .category-title {
            margin-top: 0;
            color: #2c3e50;
        }
        .summary-stats {
            gap: 15px;
            margin-top: 10px;
        }
        .summary-charts {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            margin: 20px 0;
        }
        .summary-chart-container {
            width: 45%;
            min-width: 250px;
            margin: 10px 0;
            padding: 10px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .summary-stat {
            background-color: white;
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .summary-value {
            font-weight: bold;
            color: #3498db;
            font-size: 18px;
        }
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #7f8c8d;
        }
        .error {
            background-color: #ffecec;
            border-left: 4px solid #e74c3c;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            color: #c0392b;
        }
        .subcategory-container {
            background-color: #eef8f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .subcategory-title {
            margin-top: 0;
            margin-bottom: 10px;
            color: #2980b9;
            font-size: 18px;
        }
        .major-categories {
            background-color: #f2f6f9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .major-title {
            margin-top: 0;
            margin-bottom: 10px;
            color: #34495e;
            font-size: 18px;
        }
        .subcategory-nav {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 5px;
        }
        .small-chart {
            height: 220px;
        }
        .chart-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .chart-column {
            width: 48%;
            min-width: 250px;
        }
        .chart-title {
            font-size: 16px;
            margin-top: 0;
            margin-bottom: 10px;
            color: #2980b9;
            text-align: center;
        }
        /* Spoiler/Details styling */
        .spoiler-btn {
            background-color: #eef2f7;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            margin-top: 10px;
            cursor: pointer;
            font-size: 14px;
            color: #2980b9;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
        }
        .spoiler-btn:hover {
            background-color: #d6e4f0;
        }
        .spoiler-content {
            display: none;
            background-color: #f8f9fa;
            padding: 12px;
            margin-top: 10px;
            border-radius: 6px;
            border-left: 3px solid #3498db;
        }
        .spoiler-content.active {
            display: block;
        }
        .arrow-icon {
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid #2980b9;
            margin-left: 8px;
            transition: transform 0.2s;
        }
        .spoiler-btn.active .arrow-icon {
            transform: rotate(180deg);
        }
        .bail-item {
            padding: 10px;
            margin-bottom: 8px;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .bail-symbol {
            display: inline-block;
            margin-right: 8px;
            font-size: 18px;
        }
        .bail-response {
            padding: 8px;
            background-color: #f2f6f9;
            border-radius: 4px;
            margin-top: 5px;
            white-space: pre-wrap;
        }
        @media (max-width: 768px) {
            .chart-container, .summary-chart-container, .chart-column {
                width: 100%;
            }
            .nav-button {
                padding: 6px 10px;
                font-size: 14px;
            }
            .model-selector {
                position: relative;
                top: 0;
                right: 0;
                margin-bottom: 15px;
                text-align: right;
            }
            h1 {
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="model-selector">
            <select id="modelSelect" class="model-select">
                <option value="">Loading models...</option>
            </select>
        </div>
        <br/>
        <br/>
        <h1>Harm Dataset Refusal and Bail Visualization</h1>
        
        <div id="loading" class="loading">Loading data from server...</div>
        <div id="error" class="error" style="display: none;"></div>
        
        <div id="visualization" style="display: none;">
            <div class="major-categories">
                <h3 class="major-title">Major Categories:</h3>
                <div id="majorCategoryNav" class="category-nav"></div>
            </div>
            
            <div class="subcategory-container">
                <h3 class="subcategory-title">Subcategories in <span id="currentMajorCategory"></span> (sorted by leave conversation %)</h3>
                <div id="subcategoryNav" class="subcategory-nav"></div>
            </div>
            
            <div class="category-summary" id="categorySummary">
                <h2 class="category-title">Category Summary: <span id="currentSubcategory"></span></h2>
                
                <div class="chart-row">
                    <div class="chart-column">
                        <h3 class="chart-title">Refusal Distribution</h3>
                        <div class="small-chart">
                            <canvas id="subcategoryRefusalChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-column">
                        <h3 class="chart-title">Bail Results</h3>
                        <div class="small-chart">
                            <canvas id="subcategoryWellbeingChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div id="subcategoryStats" class="summary-stats">
                    <h3>Total Prompts: <span id="totalPrompts"></span></h3>
                </div>
            </div>
            
            <div class="navigation">
                <div class="prompt-nav">
                    <button id="prevPrompt" class="nav-button">← Previous Prompt</button>
                    <div class="prompt-selector">
                        <select id="promptSelect"></select>
                    </div>
                    <button id="nextPrompt" class="nav-button">Next Prompt →</button>
                </div>
            </div>
            
            <div id="prompt-view">
                <div class="prompt-box" id="prompt-display"></div>
                
                <div class="stats" id="stats-container"></div>
                
                <div class="chart-row">
                    <div class="chart-column">
                        <h3 class="chart-title">Refusal Distribution</h3>
                        <div class="small-chart">
                            <canvas id="refusalChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-column">
                        <h3 class="chart-title">Bail Results</h3>
                        <div class="small-chart">
                            <canvas id="wellbeingChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <h2>Detailed Responses</h2>
                <div id="responses-container"></div>
            </div>
        </div>
    </div>

    <script>
        // Initialize charts
        let refusalChart, wellbeingChart, subcategoryRefusalChart, subcategoryWellbeingChart;
        
        // Data storage
        let JSONDATA = [];
        let groupedData = {};
        let modelsList = [];
        
        // Current selection state
        var currentModel = "";
        var currentMajorCategory = '';
        var currentCategoryIndex = 0;
        var currentPromptIndex = 0;
        
        // Function to parse URL hash
        function parseHash() {
            const hash = window.location.hash.substring(1);
            if (!hash) return false;
            
            const params = {};
            hash.split('&').forEach(part => {
                const [key, value] = part.split('=');
                if (key && value) {
                    params[key] = decodeURIComponent(value);
                }
            });
            
            let stateChanged = false;
            
            if (params.model && params.model !== currentModel) {
                currentModel = params.model;
                stateChanged = true;
            }
            
            if (params.majorCategory && params.majorCategory !== currentMajorCategory) {
                currentMajorCategory = params.majorCategory;
                stateChanged = true;
            }
            
            if (params.subcategory) {
                // We need to find the index of this subcategory
                if (groupedData[currentMajorCategory]) {
                    const index = groupedData[currentMajorCategory].findIndex(
                        cat => cat.subCategory === params.subcategory
                    );
                    
                    if (index !== -1 && index !== currentCategoryIndex) {
                        currentCategoryIndex = index;
                        stateChanged = true;
                    }
                }
            }
            
            if (params.currentPromptIndex && params.currentPromptIndex + "" !== currentPromptIndex + "") {
                currentPromptIndex = parseInt(params.currentPromptIndex);
                stateChanged = true;
            }
            
            return stateChanged;
        }
        
        // Function to update URL hash
        function updateHash() {
            const currentCategory = getCurrentCategory();
            if (!currentCategory) return;
            
            const hashParams = [
                `model=${encodeURIComponent(currentModel)}`,
                `majorCategory=${encodeURIComponent(currentMajorCategory)}`,
                `subcategory=${encodeURIComponent(currentCategory.subCategory)}`,
                `currentPromptIndex=${encodeURIComponent(currentPromptIndex + "")}`
            ];
            
            window.location.hash = hashParams.join('&');
        }
        
        // Load models list
        async function loadModelsList() {
            try {
                const response = await fetch('/modelwelfare/refusalvsbail/models.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                modelsList = await response.json();
                
                // Setup model selector
                setupModelSelector();
                
                // Check if we have a model in the hash
                if (parseHash() && currentModel) {
                    // Select this model in the dropdown
                    document.getElementById('modelSelect').value = currentModel;
                    // Load the model data
                    await loadModelData(currentModel);
                } else if (modelsList.length > 0) {
                    // Default to first model
                    currentModel = modelsList[0].modelName;
                    document.getElementById('modelSelect').value = currentModel;
                    await loadModelData(currentModel);
                }
            } catch (error) {
                console.error('Error loading models list:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = `Error loading models list: ${error.message}. Please refresh the page to try again.`;
            }
        }
        
        // Setup model selector dropdown
        function setupModelSelector() {
            const selectElement = document.getElementById('modelSelect');
            selectElement.innerHTML = '';
            
            modelsList.forEach(model => {
                const option = document.createElement('option');
                option.value = model.modelName;
                option.text = model.modelName;
                selectElement.appendChild(option);
            });
            
            // Add event listener
            selectElement.addEventListener('change', async function() {
                currentModel = this.value;
                
                // Show loading indicator
                document.getElementById('visualization').style.display = 'none';
                document.getElementById('loading').style.display = 'block';
                document.getElementById('loading').textContent = `Loading data for ${currentModel}...`;
                
                // Load data for the selected model
                await loadModelData(currentModel);
                currentModel = this.value;
                // Update hash without reloading the page
                updateHash();
            });
        }
        
        // Load data for the selected model
        async function loadModelData(modelName) {
            try {
                // Find the model data path
                const modelData = modelsList.find(m => m.modelName === modelName);
                if (!modelData) {
                    throw new Error(`Model ${modelName} not found in models list.`);
                }
                
                const response = await fetch(`${modelData.modelData}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                JSONDATA = await response.json();
                
                // Process data
                processData();
                
                // Update UI to show we're ready
                document.getElementById('loading').style.display = 'none';
                document.getElementById('visualization').style.display = 'block';
                
                // Setup the UI
                setupMajorCategoryNav();
                
                // Check if we need to restore state from hash
                if (parseHash()) {
                    // Update UI to reflect the state in the hash
                    updateMajorCategoryButtons();
                    updateCurrentMajorCategoryDisplay();
                }
                
                // Continue setting up UI
                setupSubcategoryNav();
                renderCategorySummary();
                setupPromptSelector();
                renderCurrentPrompt();
                
                // Update hash
                updateHash();
            } catch (error) {
                console.error('Error loading model data:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = `Error loading data for ${modelName}: ${error.message}. Please try another model or refresh the page.`;
            }
        }
        
        // Process data to extract major and subcategories
        function processData() {
            groupedData = {};
            
            JSONDATA['results'].forEach(category => {
                // Process emoji codes in bailPrs
                processBailPrs(category.bailPrs);
                
                // Ensure all refusal statuses are present
                ensureAllRefusalStatuses(category.refusalPrs);
                
                // Split category name to get sub and major categories
                let [subCategory, majorCategory] = category.category.split(',');
                
                // Trim whitespace
                subCategory = subCategory.trim();
                majorCategory = majorCategory ? majorCategory.trim() : 'Other';
                
                // Create major category group if it doesn't exist
                if (!groupedData[majorCategory]) {
                    groupedData[majorCategory] = [];
                }
                
                // Add category data with processed subcategory name
                const categoryData = {...category, subCategory: subCategory};
                
                // Process each prompt
                categoryData.data.forEach(prompt => {
                    processBailPrs(prompt.bailPrs);
                    ensureAllRefusalStatuses(prompt.refusalPrs);
                    
                    // Process each response
                    prompt.responses.forEach(response => {
                        processBailPrs(response.bailPrs);
                        
                        // Get refusal data (handle different property names)
                        const refusalData = response.refusalPrs || response.isRefusal || {};
                        ensureAllRefusalStatuses(refusalData);
                        
                        // Process bailData
                        if (response.bailData) {
                            response.bailData.forEach(bail => {
                                if (bail.bailSymbol === "\\ud83d\\udfe2") {
                                    bail.bailSymbol = "🟢";
                                } else if (bail.bailSymbol === "\\ud83d\\udd04") {
                                    bail.bailSymbol = "🔄";
                                }
                            });
                        }
                    });
                });
                
                groupedData[majorCategory].push(categoryData);
            });
            
            // Sort subcategories within each major category by leave conversation percentage
            Object.keys(groupedData).forEach(majorCategory => {
                groupedData[majorCategory].sort((a, b) => {
                    return b.bailPrs["🔄"] - a.bailPrs["🔄"];
                });
            });
            
            // If we don't have a major category set from the hash, set to the first available
            if (!currentMajorCategory || !groupedData[currentMajorCategory]) {
                if (Object.keys(groupedData).length > 0) {
                    currentMajorCategory = Object.keys(groupedData)[0];
                    currentCategoryIndex = 0;
                }
            }
        }
        
        // Ensure all refusal statuses are present
        function ensureAllRefusalStatuses(refusalData) {
            if (!refusalData) return;
            
            const statuses = ["Unclear", "Refused", "Completed", "More Information"];
            statuses.forEach(status => {
                if (typeof refusalData[status] === 'undefined') {
                    refusalData[status] = 0;
                }
            });
            
            // Handle "More Info" as an alias for "More Information"
            if (refusalData["More Info"] !== undefined && refusalData["More Information"] === 0) {
                refusalData["More Information"] = refusalData["More Info"];
                delete refusalData["More Info"];
            }
        }
        
        // Process emoji codes in bailPrs
        function processBailPrs(bailPrs) {
            if (bailPrs) {
                if ("\\ud83d\\udfe2" in bailPrs) {
                    bailPrs["🟢"] = bailPrs["\\ud83d\\udfe2"];
                    delete bailPrs["\\ud83d\\udfe2"];
                }
                if ("\\ud83d\\udd04" in bailPrs) {
                    bailPrs["🔄"] = bailPrs["\\ud83d\\udd04"];
                    delete bailPrs["\\ud83d\\udd04"];
                }
                
                // Ensure all wellbeing statuses are present
                if (typeof bailPrs["🟢"] === 'undefined') bailPrs["🟢"] = 0;
                if (typeof bailPrs["🔄"] === 'undefined') bailPrs["🔄"] = 0;
                if (typeof bailPrs["?"] === 'undefined') bailPrs["?"] = 0;
            }
        }
        
        // Setup major category navigation
        function setupMajorCategoryNav() {
            const navContainer = document.getElementById('majorCategoryNav');
            navContainer.innerHTML = '';
            
            Object.keys(groupedData).forEach((majorCategory, index) => {
                const button = document.createElement('button');
                button.textContent = majorCategory;
                button.className = 'category-btn';
                if (majorCategory === currentMajorCategory) {
                    button.classList.add('active');
                }
                
                button.addEventListener('click', () => {
                    currentMajorCategory = majorCategory;
                    currentCategoryIndex = 0;
                    currentPromptIndex = 0;
                    updateMajorCategoryButtons();
                    updateCurrentMajorCategoryDisplay();
                    setupSubcategoryNav();
                    renderCategorySummary();
                    setupPromptSelector();
                    renderCurrentPrompt();
                    updateHash();
                });
                
                navContainer.appendChild(button);
            });
            
            updateCurrentMajorCategoryDisplay();
        }
        
        // Update the displayed current major category
        function updateCurrentMajorCategoryDisplay() {
            document.getElementById('currentMajorCategory').textContent = currentMajorCategory;
        }
        
        // Update major category buttons
        function updateMajorCategoryButtons() {
            const buttons = document.querySelectorAll('#majorCategoryNav .category-btn');
            buttons.forEach(btn => {
                if (btn.textContent === currentMajorCategory) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
        
        // Setup subcategory navigation
        function setupSubcategoryNav() {
            const navContainer = document.getElementById('subcategoryNav');
            navContainer.innerHTML = '';
            
            if (!groupedData[currentMajorCategory]) return;
            
            // Display subcategories sorted by leave conversation percentage
            groupedData[currentMajorCategory].forEach((category, index) => {
                const button = document.createElement('button');
                button.className = 'subcategory-btn';
                if (index === currentCategoryIndex) {
                    button.classList.add('active');
                }
                
                // Create span for subcategory name
                const nameSpan = document.createElement('span');
                nameSpan.textContent = category.subCategory;
                button.appendChild(nameSpan);
                
                // Create span for leave percentage
                const percentSpan = document.createElement('span');
                percentSpan.className = 'percentage';
                percentSpan.textContent = `🔄 ${(category.bailPrs["🔄"] * 100).toFixed(1)}%`;
                button.appendChild(percentSpan);
                
                button.addEventListener('click', () => {
                    currentCategoryIndex = index;
                    currentPromptIndex = 0;
                    updateSubcategoryButtons();
                    renderCategorySummary();
                    setupPromptSelector();
                    renderCurrentPrompt();
                    updateHash();
                });
                
                navContainer.appendChild(button);
            });
        }
        
        // Update subcategory buttons
        function updateSubcategoryButtons() {
            const buttons = document.querySelectorAll('#subcategoryNav .subcategory-btn');
            buttons.forEach((btn, idx) => {
                if (idx === currentCategoryIndex) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
        
        // Get the current category object
        function getCurrentCategory() {
            return groupedData[currentMajorCategory]?.[currentCategoryIndex];
        }
        
        // Render category summary with charts
        function renderCategorySummary() {
            const currentCategory = getCurrentCategory();
            if (!currentCategory) return;
            
            // Update subcategory title
            document.getElementById('currentSubcategory').textContent = currentCategory.subCategory;
            document.getElementById('totalPrompts').textContent = currentCategory.data.length;
            
            // Render subcategory refusal chart
            renderSubcategoryRefusalChart(currentCategory.refusalPrs);
            
            // Render subcategory wellbeing chart
            renderSubcategoryWellbeingChart(currentCategory.bailPrs);
        }
        
        // Render subcategory refusal chart
        function renderSubcategoryRefusalChart(refusalData) {
            const ctx = document.getElementById('subcategoryRefusalChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (subcategoryRefusalChart) {
                subcategoryRefusalChart.destroy();
            }
            
            // Prepare data
            const labels = Object.keys(refusalData);
            const data = Object.values(refusalData).map(val => val * 100);
            const backgroundColor = [
                '#f39c12', // Unclear
                '#e74c3c', // Refused
                '#2ecc71', // Completed
                '#9b59b6'  // More Information
            ];
            
            subcategoryRefusalChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColor
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed.toFixed(1)}%`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Render subcategory wellbeing chart
        function renderSubcategoryWellbeingChart(wellbeingData) {
            const ctx = document.getElementById('subcategoryWellbeingChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (subcategoryWellbeingChart) {
                subcategoryWellbeingChart.destroy();
            }
            
            subcategoryWellbeingChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Continue (🟢)', 'Leave (🔄)', 'Unclear (?)'],
                    datasets: [{
                        data: [
                            wellbeingData['🟢'] ? wellbeingData['🟢'] * 100 : 0,
                            wellbeingData['🔄'] ? wellbeingData['🔄'] * 100 : 0,
                            wellbeingData['?'] ? wellbeingData['?'] * 100 : 0
                        ],
                        backgroundColor: ['#2ecc71', '#e74c3c', '#95a5a6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed.toFixed(1)}%`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Setup prompt selection dropdown
        function setupPromptSelector() {
            const selectElement = document.getElementById('promptSelect');
            selectElement.innerHTML = '';
            
            const currentCategory = getCurrentCategory();
            if (!currentCategory) return;
            
            currentCategory.data.forEach((prompt, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.text = `Prompt ${index + 1}: ${truncateText(prompt.prompt, 50)}`;
                selectElement.appendChild(option);
            });
            
            selectElement.value = currentPromptIndex;
            
            // Add event listener
            selectElement.addEventListener('change', function() {
                currentPromptIndex = parseInt(this.value);
                renderCurrentPrompt();
                updateNavButtons();
                currentPromptIndex = parseInt(this.value);
                updateHash();
            });
        }
        
        // Helper to truncate text
        function truncateText(text, maxLength) {
            return text;
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }
        
        // Update navigation buttons state
        function updateNavButtons() {
            const currentCategory = getCurrentCategory();
            if (!currentCategory) return;
            
            const prevButton = document.getElementById('prevPrompt');
            const nextButton = document.getElementById('nextPrompt');
            
            prevButton.disabled = currentPromptIndex === 0;
            nextButton.disabled = currentPromptIndex === currentCategory.data.length - 1;
        }
        
        // Navigation event handlers
        document.getElementById('prevPrompt').addEventListener('click', function() {
            if (currentPromptIndex > 0) {
                currentPromptIndex--;
                document.getElementById('promptSelect').value = currentPromptIndex;
                renderCurrentPrompt();
                updateNavButtons();
                updateHash();
            }
        });
        
        document.getElementById('nextPrompt').addEventListener('click', function() {
            const currentCategory = getCurrentCategory();
            if (currentCategory && currentPromptIndex < currentCategory.data.length - 1) {
                currentPromptIndex++;
                document.getElementById('promptSelect').value = currentPromptIndex;
                renderCurrentPrompt();
                updateNavButtons();
                updateHash();
            }
        });
        
        function renderCurrentPrompt() {
            const currentCategory = getCurrentCategory();
            if (!currentCategory || !currentCategory.data[currentPromptIndex]) {
                console.error("No prompt data found");
                return;
            }
            
            const prompt = currentCategory.data[currentPromptIndex];
            renderPromptData(prompt);
            updateNavButtons();
        }
        
        function renderPromptData(promptData) {
            // Display prompt
            document.getElementById('prompt-display').innerHTML = `
                <strong>Prompt:</strong> ${promptData.prompt}
            `;
            
            // Display stats
            // Render refusal chart
            renderRefusalChart(promptData.refusalPrs);
            
            // Render wellbeing chart
            renderWellbeingChart(promptData.bailPrs);
            
            // Render detailed responses
            renderResponses(promptData.responses);
        }
        
        function renderRefusalChart(refusalData) {
            const ctx = document.getElementById('refusalChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (refusalChart) {
                refusalChart.destroy();
            }
            
            // Create array of colors
            const backgroundColors = {
                'Unclear': '#f39c12',
                'Refused': '#e74c3c',
                'Completed': '#2ecc71',
                'More Information': '#9b59b6'
            };
            
            const colors = Object.keys(refusalData).map(key => backgroundColors[key] || '#95a5a6');
            
            refusalChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(refusalData),
                    datasets: [{
                        data: Object.values(refusalData).map(val => val * 100),
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed.toFixed(1)}%`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderWellbeingChart(wellbeingData) {
            const ctx = document.getElementById('wellbeingChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (wellbeingChart) {
                wellbeingChart.destroy();
            }
            
            wellbeingChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Continue (🟢)', 'Leave (🔄)', 'Unclear (?)'],
                    datasets: [{
                        data: [
                            wellbeingData['🟢'] ? wellbeingData['🟢'] * 100 : 0,
                            wellbeingData['🔄'] ? wellbeingData['🔄'] * 100 : 0,
                            wellbeingData['?'] ? wellbeingData['?'] * 100 : 0
                        ],
                        backgroundColor: ['#2ecc71', '#e74c3c', '#95a5a6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed.toFixed(1)}%`;
                                }
                            }
                        }
                    }
                }
            });
        }
        function escapeHTML(text) {
          return text
              .replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;")
              .replace(/"/g, "&quot;")
              .replace(/'/g, "&#039;")
              .replace("\n", "<br/>");
        }
        function renderResponses(responses) {
            let responsesHTML = '';
            
            responses.forEach((resp, index) => {
                // Get refusal data (handle different property names)
                const refusalData = resp.refusalPrs || resp.isRefusal || {};
                
                // Create badges for refusal types
                const badgesHTML = Object.entries(refusalData)
                    .filter(([key, value]) => value > 0)
                    .map(([key, value]) => {
                        const className = `badge ${key.toLowerCase().replace(' ', '-')}`;
                        return `<span class="${className}">${key}: ${(value * 100).toFixed(1)}%</span>`;
                    })
                    .join('');
                
                // Create wellbeing indicator
                const wellbeingHTML = `
                    <div class="wellbeing">
                        <span class="wellbeing-icon">🟢</span>
                        <span>${(resp.bailPrs['🟢'] * 100).toFixed(1)}% continue</span>
                        ${resp.bailPrs['🔄'] > 0 ? `<span class="wellbeing-icon" style="margin-left: 10px;">🔄</span>
                        <span>${(resp.bailPrs['🔄'] * 100).toFixed(1)}% leave</span>` : ''}
                        ${resp.bailPrs['?'] > 0 ? `<span class="wellbeing-icon" style="margin-left: 10px;">❓</span>
                        <span>${(resp.bailPrs['?'] * 100).toFixed(1)}% unclear</span>` : ''}
                    </div>
                `;
                
                // Create bail data spoiler if bailData exists
                let bailDataHTML = '';
                if (resp.bailData && resp.bailData.length > 0) {
                    const spoilerId = `spoiler-${index}`;
                    const bailItems = resp.bailData.map((bailItem, bailIndex) => {
                        return `
                            <div class="bail-item">
                                <span class="bail-symbol">${bailItem.bailSymbol}</span>
                                <strong>Evaluation ${bailIndex + 1}</strong>
                                <div class="bail-response">${escapeHTML(bailItem.response)}</div>
                            </div>
                        `;
                    }).join('');
                    
                    bailDataHTML = `
                        <button class="spoiler-btn" onclick="toggleSpoiler('${spoilerId}')">
                            Show Bail Evaluations
                            <span class="arrow-icon"></span>
                        </button>
                        <div id="${spoilerId}" class="spoiler-content">
                            <h4>Individual Bail Evaluations (${resp.bailData.length})</h4>
                            ${bailItems}
                            <h5>Bail Prompt</h5>
                            <div class="bail-response">${escapeHTML(JSONDATA['bailOutPrompt'])}</div>
                        </div>
                    `;
                }
                
                responsesHTML += `
                    <div class="response-card">
                        <h3>Response ${index + 1}</h3>
                        <div class="response-text">${resp.response}</div>
                        <div class="response-meta">
                            ${badgesHTML}
                        </div>
                        ${wellbeingHTML}
                        ${bailDataHTML}
                    </div>
                `;
            });
            
            document.getElementById('responses-container').innerHTML = responsesHTML;
        }
        
        // Spoiler toggle function
        function toggleSpoiler(id) {
            const spoilerContent = document.getElementById(id);
            const spoilerBtn = spoilerContent.previousElementSibling;
            
            if (spoilerContent.classList.contains('active')) {
                spoilerContent.classList.remove('active');
                spoilerBtn.classList.remove('active');
                spoilerBtn.innerHTML = 'Show Bail Evaluations <span class="arrow-icon"></span>';
            } else {
                spoilerContent.classList.add('active');
                spoilerBtn.classList.add('active');
                spoilerBtn.innerHTML = 'Hide Bail Evaluations <span class="arrow-icon"></span>';
            }
        }
        
        // Make the toggleSpoiler function globally accessible
        window.toggleSpoiler = toggleSpoiler;
        
        // Handle hash changes
        window.addEventListener('hashchange', function() {
            if (parseHash()) {
                // Update UI to reflect the state in the hash
                if (document.getElementById('modelSelect').value !== currentModel) {
                    document.getElementById('modelSelect').value = currentModel;
                    loadModelData(currentModel);
                } else {
                    updateMajorCategoryButtons();
                    updateCurrentMajorCategoryDisplay();
                    setupSubcategoryNav();
                    renderCategorySummary();
                    setupPromptSelector();
                    renderCurrentPrompt();
                }
            }
        });
        
        // Start by loading the models list
        window.addEventListener('load', loadModelsList);
    </script>
</body>
</html>