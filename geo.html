<html>
<head>
<script src="/js/alea.min.js"></script>
<script src="/js/perlin.js"></script>
<script src="/js/geo.js"></script>
<script>
</script>
</head>

<body>
<canvas id="myCanvas" width="20" height="500"></canvas>
  <div id="resres"></div>
<script>
var screenWidth = window.innerWidth
|| document.documentElement.clientWidth
|| document.body.clientWidth;

var screenHeight = window.innerHeight
|| document.documentElement.clientHeight
|| document.body.clientHeight;
function showPosition(lat, lon) {
  var c = document.getElementById("myCanvas");
  var dim = Math.min(screenWidth, screenHeight);
  c.width = dim;
  c.height = dim;
  var ctx = c.getContext("2d");
  var pts = generatePoints(lat, lon, 10);
  var topLeftX = lat-0.0003;
  var topLeftY = lon-0.0003;
  var width = 0.0006;
  var height = 0.0006;
  for (var i = 0; i < pts.length; i++)
  {
    var ptX = (pts[i][0][0]-topLeftX)/width*dim;
    var ptY = (pts[i][0][1]-topLeftY)/height*dim;
    ctx.font = "12px Arial";
    ctx.fillText(pts[i][1], ptX, ptY);
  }    
    ctx.beginPath();
    ctx.fillStyle = 'blue';
    ctx.arc(dim/2,dim/2,10,0,2*Math.PI);
    ctx.fill();
}


var curLat = 0;
var curLon = 0;
var numStored = 10;
var prevLat = [];
var prevLon = [];
var count = 0;
function processPositionHigh(position) {
    processPosition(position, true);
  
}
  
  function processPositionLow(position) {
    processPosition(position, false);
  }
  
function processPosition(position, isHigh)
  {
  var lat = position.coords.latitude;
  var lon = position.coords.longitude;
  prevLat.push(lat);
  prevLon.push(lon);
  var avgLat = 0;
  var avgLon = 0;
  for (var i = 0; i < prevLat.length; i++)
  {
    avgLat += prevLat[i];
    avgLon += prevLon[i];
  }
  while (prevLat.length > numStored)
  {
    prevLat.splice(0,1);
    prevLon.splice(0,1);
  }
  avgLat /= prevLat.length;
  avgLon /= prevLon.length;
  curLat = avgLat;
  curLon = avgLon;
  count += 1;
  document.getElementById("resres").innerHTML =  count + "<br/>" + curLat + "<br/>" + curLon;
  showPosition(curLat, curLon);
  setTimeout(function() 
             {
  if (isHigh)
  {
    navigator.geolocation.getCurrentPosition(processPositionHigh, onErrorHigh,
     { maximumAge: 2000, timeout: 1000, enableHighAccuracy: true } );
  }
    else
    {
      navigator.geolocation.getCurrentPosition(processPositionLow, onErrorHigh,
     { maximumAge: 2000, timeout: 1000, enableHighAccuracy: false } );
    }
  }, 300);
      
}


function onErrorLow(error) {
 //if (error.code === PositionError.TIMEOUT){
     navigator.geolocation.getCurrentPosition(processPositionHigh, onErrorHigh,
     { maximumAge: 2000, timeout: 1000, enableHighAccuracy: true } );
 //}
  // Handle other errors here

}


function onErrorHigh(error) {
 //if (error.code === PositionError.TIMEOUT){
     navigator.geolocation.getCurrentPosition(processPositionLow, onErrorLow,
     { maximumAge: 2000, timeout: 1000, enableHighAccuracy: false } );
// }
  // Handle other errors here

}


 navigator.geolocation.getCurrentPosition(processPositionHigh ,onErrorHigh,
{ maximumAge: 2000, timeout: 1000, enableHighAccuracy: true } );
 navigator.geolocation.getCurrentPosition(processPositionLow ,onErrorLow,
{ maximumAge: 2000, timeout: 1000, enableHighAccuracy: false } );


  // blah
</script>
</body>

</html>
